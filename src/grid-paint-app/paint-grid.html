<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<dom-module id="paint-grid">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .row {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
      }

      .cell {
        width: 24px;
        height: 24px;
        border: 1px solid black;
        background-color: white;
      }

      .cell--filled {
        background-color: black;
      }
    </style>
    <template is="dom-repeat" items="[[rows]]" as="row">
      <div class="row">
        <template is="dom-repeat" items="[[row.cells]]" as="cell">
          <div class$="[[_getCellClass(cell.isFilled)]]" on-tap="toggleCell" cell-w="[[cell.w]]" cell-h="[[cell.h]]"></div>
        </template>
      </div>
    </template>
  </template>
  <script>
      class PaintGrid extends Polymer.GestureEventListeners(Polymer.Element) {
          static get is() {
              return 'paint-grid'
          }

          static get properties() {
              return {
                  width: {
                      type: Number,
                      observer: '_onWidthChanged'
                  },
                  height:  {
                      type: Number,
                      observer: '_onHeightChanged'
                  },
                  cells: Array,

                  rows: {
                      type: Array,
                      computed: '_computeRows(width, height, cells)'
                  }
              }
          }

          _onWidthChanged(newValue, oldValue) {
              if (oldValue !== undefined) {
                  this._onSizeChanged(
                      { width: newValue, height: this.height },
                      { width: oldValue, height: this.height });
              }
          }

          _onHeightChanged(newValue, oldValue) {
              if (oldValue !== undefined) {
                  this._onSizeChanged(
                      {width: this.width, height: newValue},
                      {width: this.width, height: oldValue});
              }
          }

          _onSizeChanged(newSize, oldSize) {
              const cells = new Array(newSize.width * newSize.height);
              for (let w = 0; w < newSize.width; w += 1) {
                  for (let h = 0; h < newSize.height; h += 1) {
                      cells[newSize.width * h + w] =
                          w < oldSize.width && h < oldSize.height ? this.cells[oldSize.width * h + w] : 0;
                  }
              }
              this.cells = cells;
          }

          _computeRows(width, height, cells) {
              if (!cells || cells.length < width * height) {
                  return [];
              }

              let rows = [];
              for (let h = 0; h < height; h += 1) {
                  let row = [];
                  for (let w = 0; w < width; w += 1) {
                      row.push({ w: w, h: h, isFilled: cells[width * h + w] > 0 });
                  }
                  rows.push({ cells: row });
              }
              return rows;
          }

          _getCellClass(isFilled) {
              return 'cell' + (isFilled ? ' cell--filled' : '');
          }

          toggleCell(event) {
              this.set(`rows.${event.model.cell.h}.cells.${event.model.cell.w}.isFilled`,
                  !this.rows[event.model.cell.h].cells[event.model.cell.w].isFilled);
          }
    }

    customElements.define(PaintGrid.is, PaintGrid);
  </script>
</dom-module>
